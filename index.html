<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Aprende Python - M√≥dulo interactivo mejorado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>M√≥dulo interactivo: Aprende Python desde cero</h1>
    <p class="intro">Aprende Python dentro de una tem√°tica divertida: <strong>"La aventura del programador explorador"</strong>. Completa los retos para ayudar a nuestro explorador digital a avanzar.</p>

    <div class="stats">
        ‚úîÔ∏è Correctas: <span id="correct-count">0</span> &nbsp;&nbsp; ‚ùå Incorrectas: <span id="incorrect-count">0</span>
    </div>

    <!-- Pantalla inicial para nombre y apellido + recuadro de desencriptado -->
    <div id="startScreen" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;z-index:9999;">
        <div style="background:#fff;padding:22px;border-radius:10px;min-width:320px;max-width:760px;width:94%;box-sizing:border-box;">
            <h2 style="margin-top:0;">Identif√≠cate</h2>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <input id="firstName" placeholder="Nombre" style="padding:8px;border-radius:6px;border:1px solid #ccc;">
                <input id="lastName" placeholder="Apellido" style="padding:8px;border-radius:6px;border:1px solid #ccc;">
                <button id="startButton" style="padding:10px;border:none;background:#007bff;color:#fff;border-radius:6px;cursor:pointer;">Comenzar</button>
            </div>
        </div>
        <!-- Verificaci√≥n de identificador -->
        <div id="cipherCheckContainer" style="background:#fff;padding:20px;border-radius:10px;margin-top:20px;width:100%;max-width:760px;box-sizing:border-box;">
            <h2 style="margin-top:0;">Verificar identificador cifrado</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start;">
                <textarea id="cipherInput" placeholder="Pega aqu√≠ el identificador cifrado"
                    style="flex:1;min-height:90px;padding:10px;border-radius:6px;border:1px solid #ccc;resize:vertical;"></textarea>
                <button id="cipherDecodeBtn" style="padding:10px 16px;border:none;background:#17a2b8;color:#fff;border-radius:6px;cursor:pointer;height:40px;">Desencriptar üîç</button>
            </div>
            <div id="cipherOutput" style="margin-top:12px;background:#f5f5f5;padding:10px;border-radius:6px;min-height:50px;white-space:pre-wrap;word-break:break-word;border:1px solid #ccc;"></div>
        </div>
    </div>

    <div id="quiz"></div>

    <div id="resultModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;">
        <div style="background:#fff;padding:30px;border-radius:12px;max-width:520px;width:92%;text-align:center;position:relative;">
            <h2>¬°Has completado el m√≥dulo!</h2>
            <p id="modalText"></p>
            <button id="closeModal" style="padding:8px 16px;border:none;background:#28a745;color:#fff;border-radius:6px;cursor:pointer;">Reiniciar üîÑ</button>
            <div id="verifyResult" style="margin-top:12px;color:#333;text-align:left;"></div>
        </div>
    </div>

    <script>

        const questions = [
            {
                id: "q1",
                tutorial: "En Python, `print()` se usa para mostrar mensajes en pantalla. Los textos siempre van entre comillas, simples '...' o dobles \"...\". Esto indica que Python los trata como cadenas de caracteres.",
                explain: "Est√°s en lo alto de una monta√±a. Para expresar tu satisfacci√≥n al mundo, necesitas usar print() correctamente.",
                title: "1) Enviar un mensaje m√°gico",
                exerciseHtml: 'Grita: <pre class="exercise">print(<span class="drop" data-expected=\'"Success"\'>_____</span>)</pre>',
                options: ['"Success"', 'Success', 'print Success', 'mensaje'],
                correctFeedback: '¬°El mundo te escucha! print() siempre recibe cadenas entre comillas.',
                wrongFeedback: 'El mundo no entienden mensajes sin comillas.',
                imageUrl: 'images/q1.png'
            },
            // {
            //     id: "q2",
            //     tutorial: "Las variables son cofres donde guardamos tesoros (valores). Para asignar un valor a una variable, usamos el s√≠mbolo `=`. Por ejemplo, `oro = 100` guarda el n√∫mero 100 dentro de la variable 'oro'.",
            //     explain: "En la Cueva de los Datos necesitas guardar valores dentro de cofres (variables).",
            //     title: "2) Guardar un tesoro en una variable",
            //     exerciseHtml: 'Completa el cofre: <pre class="exercise">oro <span class="drop" data-expected="=">_____</span> <span class="drop" data-expected="100">_____</span></pre>',
            //     options: ['=', '==', '100', '"100"'],
            //     correctFeedback: '¬°Tesoro asegurado! = asigna un valor a la variable.',
            //     wrongFeedback: 'Ese cofre no se cierra. Usa = para guardar el valor.',
            //     imageUrl: 'images/q2.png'
            // },
            // {
            //     id: "q3",
            //     tutorial: "Las listas en Python son colecciones de elementos ordenados. Python empieza a contar desde 0, as√≠ que el primer elemento est√° en la posici√≥n 0, el segundo en la 1, y as√≠ sucesivamente.",
            //     explain: "Dentro de la Piramide de los Arreglos encuentras listas antiguas. Para leerlas, debes recordar que empiezan en 0.",
            //     title: "3) Leer un s√≠mbolo antiguo",
            //     exerciseHtml: 'Descifra: <pre class="exercise">runas = ["luna", "estrella", "sol"]\nprint(runas[<span class="drop" data-expected="2">_____</span>])</pre>',
            //     options: ['0', '1', '2', '3'],
            //     correctFeedback: 'Correcto. La runa 2 es "sol".',
            //     wrongFeedback: 'Esa no es la runa. Revisa la numeraci√≥n.',
            //     imageUrl: 'images/q3.png'
            // },
            // {
            //     id: "q4",
            //     tutorial: "Las condiciones permiten que tu c√≥digo tome decisiones. La instrucci√≥n `if` comprueba si algo es verdadero, y solo entonces ejecuta el bloque de c√≥digo dentro.",
            //     explain: "Llegas al Puente del Juicio. Solo pasar√°s si sabes usar correctamente las condiciones.",
            //     title: "4) Evaluar una condici√≥n",
            //     exerciseHtml: 'Comprueba el viento: <pre class="exercise">viento = 9\n<span class="drop" data-expected="if">_____</span> viento <span class="drop" data-expected="<">_____</span> 10:<br>    print("Viento inferior a 10")</pre>',
            //     options: ['if', 'elif', '>', '<', 'else'],
            //     correctFeedback: '¬°El viento est√° calmado! if viento < 10.',
            //     wrongFeedback: '¬øSeguro que est√°s comprobando bien?',
            //     imageUrl: 'images/q4.png'
            // },
            // {
            //     id: "q5",
            //     tutorial: "En Python, un bucle *for* sirve para repetir instrucciones. La funci√≥n *range(n)* genera una secuencia de n√∫meros desde 0 hasta n-1. Por ejemplo, range(2) produce 0 y 1, as√≠ que el bloque dentro del for se ejecuta dos veces.<br>",
            //     explain: "Est√°s en la Torre del Tiempo, donde los bucles controlan el flujo.",
            //     title: "5) Muestra todos los pasos <u>salt√°ndote el primero</u>",
            //     exerciseHtml: 'Completa: <pre class="exercise">pasos = ["Revisar hora", "Subir torre", "Vencer jefe"]<br>for index in range(<span class="drop" data-expected="2">_____</span>):<br>    print(paso[<span class="drop" data-expected="index + 1">_____</span>])</pre>',
            //     options: ['2', '3', 'index', 'index + 1'],
            //     correctFeedback: 'Ritual ejecutado correctamente.',
            //     wrongFeedback: 'Esos no son los pasos a seguir',
            //     imageUrl: 'images/q5.png'
            // }
        ];

        let correctCount = 0;
        let incorrectCount = 0;
        let currentIndex = 0;

        let firstName = '';
        let lastName = '';

        function updateStats() {
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = incorrectCount;
        }

        // referencia al contenedor "viewport"
        const container = document.getElementById('quiz');

        let slider, cardElements;

        function createCarouselStructure() {
            container.innerHTML = '';

            // style del contenedor viewport
            container.style.overflow = "hidden";
            container.style.width = "100%";
            container.style.boxSizing = "border-box";

            slider = document.createElement('div');
            slider.id = "slider";
            slider.style.display = "flex";
            slider.style.transition = "transform 0.45s ease";
            slider.style.willChange = "transform";

            container.appendChild(slider);

            questions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.boxSizing = "border-box";
                card.style.display = "block";
                card.style.padding = "20px";

                // dentro del forEach, por ejemplo:
                const isLast = (i === questions.length - 1);

                card.innerHTML = `
                <div class="card-content" style="display:flex;gap:20px;align-items:flex-start;">
                    <div class="left" style="flex:1;">
                    <div class="tutorial">${q.tutorial}</div>
                    <div class="explain">${q.explain}</div>
                    <strong>${q.title}</strong>
                    <div class="exercise-area">${q.exerciseHtml}</div>
                    <div class="tokens" id="${q.id}-tokens" style="display:flex;gap:8px;margin-top:10px;"></div>
                    <div class="controls" style="margin-top:12px;">
                        <button type="button" data-check="${q.id}">Comprobar</button>
                        ${ !isLast
                            ? `<button type="button" data-next="${q.id}" style="display:none;margin-left:8px;">Siguiente ‚ûú</button>`
                            : `<button type="button" data-next="${q.id}" style="display:none;margin-left:8px;">Finalizar ‚úÖ</button>`
                        }
                    </div>
                    <div class="feedback" id="${q.id}-fb" style="margin-top:8px;"></div>
                    </div>
                    <div class="right" style="flex:1;display:flex;justify-content:center;align-items:center;">
                    <img src="${q.imageUrl}" alt="" style="max-width:100%;height:auto;border-radius:8px;">
                    </div>
                </div>
                `;

                slider.appendChild(card);

                // tokens
                const tokensContainer = card.querySelector(`#${q.id}-tokens`);
                q.options.forEach(opt => {
                    const tok = document.createElement('div');
                    tok.className = 'token';
                    tok.draggable = true;
                    tok.dataset.value = opt;
                    tok.textContent = opt;
                    tok.style.padding = "6px 10px";
                    tok.style.border = "1px solid #ccc";
                    tok.style.borderRadius = "6px";
                    tok.style.cursor = "grab";
                    tokensContainer.appendChild(tok);

                    tok.addEventListener('dragstart', e => {
                        if (!tok.classList.contains('used')) e.dataTransfer.setData('text/plain', opt);
                        else e.preventDefault();
                    });
                });

                // drops
                const drops = card.querySelectorAll('.drop');
                drops.forEach(d => {
                    d.addEventListener('dragover', e => {
                        e.preventDefault();
                        d.classList.add('over');
                    });
                    d.addEventListener('dragleave', () => d.classList.remove('over'));
                    d.addEventListener('drop', e => {
                        e.preventDefault();
                        d.classList.remove('over');
                        const val = e.dataTransfer.getData('text/plain');
                        d.textContent = val;
                        d.dataset.current = val;
                        d.classList.remove('success', 'fail');
                    });
                });

                // comprobar
                card.querySelector(`[data-check="${q.id}"]`).addEventListener('click', () => {
                    const fb = card.querySelector(`#${q.id}-fb`);
                    fb.innerHTML = '';
                    let allCorrect = true;

                    drops.forEach(d => {
                        const expected = d.dataset.expected;
                        const current = d.dataset.current || '';
                        if (current === expected) {
                            d.classList.add('success');
                            d.classList.add('used');
                            d.classList.remove('fail');
                        } else {
                            d.classList.add('fail');
                            d.classList.remove('success');
                            allCorrect = false;
                        }
                    });

                    if (allCorrect) {
                        fb.innerHTML = `<div class="feedback correct">${q.correctFeedback}</div>`;
                        if (!fb.dataset.checked) {
                            correctCount++;
                            fb.dataset.checked = "true";
                        }
                        // mostrar siguiente
                        card.querySelector(`[data-next="${q.id}"]`).style.display = "inline-block";
                    } else {
                        fb.innerHTML = `<div class="feedback wrong">${q.wrongFeedback}</div>`;
                        if (!fb.dataset.checked) {
                            incorrectCount++;
                            fb.dataset.checked = "true";
                        }
                    }
                    updateStats();
                });

                // next
                const nextBtn = card.querySelector(`[data-next="${q.id}"]`);
                if (isLast) {
                    nextBtn.addEventListener('click', async () => {
                        // mostrar modal con texto cifrado que identifica nombre, apellido y resultados
                        const modal = document.getElementById('resultModal');
                        const modalText = document.getElementById('modalText');

                        const payload = {
                            firstName: firstName,
                            lastName: lastName,
                            correct: correctCount,
                            incorrect: incorrectCount,
                            date: new Date()
                        };

                        const cipher = encodeData(payload);

                        // guardar el cipher en dataset para que el bot√≥n de verificaci√≥n lo lea
                        modal.dataset.cipher = cipher;


                        // Render inicial
                        modalText.innerHTML = `
                            Correctas: ${correctCount} <br>
                            Incorrectas: ${incorrectCount} <br><br>
                            Identificador cifrado:<br>

                            <pre style="word-break:break-all; background:#f5f5f5;padding:8px;border-radius:6px;white-space:pre-wrap;max-height:none;overflow:visible;">${cipher}</pre>
                        `;
                        // limpiar resultado de verificaci√≥n anterior
                        document.getElementById('verifyResult').innerHTML = '';
                        modal.style.display = 'flex';
                    });
                } else {
                    nextBtn.addEventListener('click', () => moveNext());
                }

                // cerrar modal
                document.getElementById('closeModal').addEventListener('click', () => {
                    const modal = document.getElementById('resultModal');
                    modal.style.display = 'none';

                    // reiniciar contadores y stats
                    correctCount = 0;
                    incorrectCount = 0;
                    updateStats();

                    // volver a la primera pregunta
                    currentIndex = 0;

                    // resetear nombre/apellido para que se pida de nuevo
                    firstName = '';
                    lastName = '';

                    // mostrar pantalla inicial
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                    document.getElementById('startScreen').style.display = 'flex';

                    // limpiar quiz
                    container.innerHTML = '';
                });
            });

            // after creating cards, collect them
            cardElements = Array.from(slider.children);

            // establecer anchos iniciales
            recalcSizes();
        }

        // recalc tama√±os en px seg√∫n el ancho real del contenedor (viewport)
        function recalcSizes() {
            if (!slider) return;
            const viewportWidth = container.clientWidth || document.documentElement.clientWidth;
            // ancho total del slider: ancho viewport * n tarjetas
            slider.style.width = `${viewportWidth * questions.length}px`;
            // cada tarjeta ocupa exactamente el ancho del viewport (en px)
            cardElements.forEach(card => {
                card.style.minWidth = `${viewportWidth}px`;
                card.style.maxWidth = `${viewportWidth}px`;
            });
            // ajustar transform para centrar la tarjeta actual
            updateSlider();
        }

        function updateSlider() {
            const viewportWidth = container.clientWidth || document.documentElement.clientWidth;
            const offset = currentIndex * viewportWidth;
            slider.style.transform = `translateX(-${offset}px)`;
        }

        function moveNext() {
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                updateSlider();
            }
        }

        // reconstruir al cambiar tama√±o
        window.addEventListener('resize', () => {
            // un peque√±o debounce
            clearTimeout(window._quizResizeTimer);
            window._quizResizeTimer = setTimeout(() => {
                recalcSizes();
            }, 120);
        });

        // funci√≥n simple de "cifrado" (base64 de JSON) para mostrar identificador
        function encodeData(obj) {
            const str = JSON.stringify(obj);
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                return btoa(str);
            }
        }

        // funci√≥n inversa para decodificar el identificador
        function decodeData(base64) {
            try {
                const json = decodeURIComponent(escape(atob(base64)));
                return JSON.parse(json);
            } catch (e) {
                try {
                    return JSON.parse(atob(base64));
                } catch (e2) {
                    return null;
                }
            }
        }

        // Start button logic
        document.getElementById('startButton').addEventListener('click', () => {
            const fn = document.getElementById('firstName').value.trim();
            const ln = document.getElementById('lastName').value.trim();
            if (!fn || !ln) {
                alert('Por favor ingresa nombre y apellido para continuar.');
                return;
            }
            firstName = fn;
            lastName = ln;
            document.getElementById('startScreen').style.display = 'none';

            // inicializar estad√≠sticas y generar estructura
            correctCount = 0;
            incorrectCount = 0;
            updateStats();
            currentIndex = 0;
            createCarouselStructure();
        });

        document.getElementById('cipherDecodeBtn').addEventListener('click', () => {
            const input = document.getElementById('cipherInput').value.trim();
            const output = document.getElementById('cipherOutput');
            
            if (!input) {
                output.textContent = 'Introduce un identificador cifrado para desencriptar.';
                return;
            }

            const decoded = decodeData(input);

            if (!decoded) {
                output.textContent = 'No se pudo desencriptar o el contenido no es JSON v√°lido.';
                return;
            }



            // Mostrar de forma legible
            output.textContent = JSON.stringify(decoded, null, 2);
        });

        // No renderizar el quiz hasta que el usuario ingrese su nombre.
        updateStats();

    </script>
</body>
</html>